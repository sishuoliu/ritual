═══════════════════════════════════════════════════════════════════════════════
              《功德轮回：众生百态》v3.6 最终版
              
              回测系统完善 + 平衡调优报告
═══════════════════════════════════════════════════════════════════════════════

更新日期：2026年1月28日
版本：v3.6.0（回测完善 + 事件卡微调 + 平衡定稿）


═══════════════════════════════════════════════════════════════════════════════
                    一、回测系统完善说明
═══════════════════════════════════════════════════════════════════════════════

▌1.1 设计目标（参考互联网与最佳实践）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

• 可复现：固定种子（seed）使同一配置得到相同结果，便于对比调参
• 多情景：6 种配置（全皈依/全不皈依/商人财富/农夫福德/学者智慧/僧侣福德）覆盖不同策略与皈依组合
• 真实模拟：事件牌序、众生牌序、骰子、行动评估随机均使用同一 RNG，支持多种子方差分析
• 失败细分：统计「劫难过高」「渡化不足」「两者皆有」占比，避免单一失败原因
• 事件卡参数化：事件效果（calamity、fu_all、hui_all、wealth_all）可注入，便于微调而不改核心逻辑
• 跨机制调优：不单在单一机制上反复调数，从事件卡、渡化门槛、众生数量等多处入手

▌1.2 新增/修改文件
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【模拟器】game_simulator_v3.5_final.py
• 支持注入：event_effects（事件牌列表）、beings_template（众生牌）、save_required、max_rounds、calamity_limit
• 支持种子：rng=random.Random(seed)，骰子与行动随机均用 self.rng
• 默认事件牌：已更新为 v3.6 微调值（见下）

【回测模块】backtest_system.py（新建）
• BacktestConfig：种子、局数、配置列表、事件牌工厂、save_required 等
• run_single_backtest：单配置、单种子、多局，返回胜率、失败原因、角色统计
• run_full_backtest：多配置、综合排名分
• run_sensitivity：单参数扫描（如 save_required、事件 calamity 值）
• 事件卡工厂：default_event_deck、tuned_event_deck_v36

【平衡调优脚本】balance_tuning_v36.py（新建）
• 基线（v3.5 默认事件）、方案A（事件微调）、方案B（事件微调+save_required=5）、方案C（保留一定负面）
• 输出各方案胜率、失败原因占比、综合排名分，并给出推荐方案

【说明】README_回测与v3.6.md（新建）
• 回测系统使用说明、事件卡 v3.6 表、运行方法、v3.6 参数汇总


═══════════════════════════════════════════════════════════════════════════════
                    二、平衡调优思路（批判性）
═══════════════════════════════════════════════════════════════════════════════

▌2.1 问题（v3.5）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

• 失败原因 100% 为渡化不足；劫难过高导致的失败几乎为 0
• 农夫综合排名分 -8，偏弱
• 若只在「渡化门槛」或「发愿数值」上反复上下调，容易陷入单点振荡

▌2.2 策略
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

• 重点微调事件卡：减轻负面事件（旱灾/洪水/瘟疫）、略增强正面（国泰民安），使劫难相关失败占比出现，同时缓解团队压力
• 可选杠杆：渡化门槛 save_required 6→5、众生池数量、生存消耗等，通过多方案对比选取
• 不单独反复调某一机制数值，而是事件卡 + 渡化/众生/生存 组合观察


═══════════════════════════════════════════════════════════════════════════════
                    三、事件卡 v3.6 最终表（推荐方案A）
═══════════════════════════════════════════════════════════════════════════════

┌──────────────────────────────────────────────────────────────────────────────┐
│  事件名      │  v3.5 效果              │  v3.6 效果（定稿）           │ 说明   │
├──────────────┼─────────────────────────┼─────────────────────────────┼────────┤
│  旱灾        │  calamity +2             │  calamity +1                 │ 减轻   │
│  洪水        │  calamity +2             │  calamity +1                 │ 减轻   │
│  瘟疫        │  calamity +3, 财-1       │  calamity +2, 财-1           │ 减轻   │
│  丰收        │  wealth_all +2           │  不变                        │ -      │
│  法会        │  fu_all +1, hui_all +1   │  不变                        │ -      │
│  高僧开示    │  hui_all +2              │  不变                        │ -      │
│  国泰民安    │  calamity -2             │  calamity -3                 │ 增强   │
│  浴佛节      │  fu_all +2               │  不变                        │ -      │
└──────────────────────────────────────────────────────────────────────────────┘

• 预期：劫难相关失败占比不再为 0，渡化不足仍可能为主要失败原因但非 100%
• 胜率目标：全皈依+平衡 85–92%


═══════════════════════════════════════════════════════════════════════════════
                    四、可选方案 B / C（供扩展）
═══════════════════════════════════════════════════════════════════════════════

【方案B】事件卡同方案A + save_required=5
• 降低渡化门槛，进一步分散失败原因，胜率会升高
• 适合希望「更容易过关」或「失败原因更均衡」的局

【方案C】事件卡：旱灾/洪水保持 +2，瘟疫改为 +2，国泰民安 -2
• 保留一定劫难压力，劫难失败占比会高于方案A
• 适合希望「劫难感更强」的局


═══════════════════════════════════════════════════════════════════════════════
                    五、v3.6 最终版参数汇总（与 v3.5 一致部分略）
═══════════════════════════════════════════════════════════════════════════════

【变更】
• 事件卡：采用上表 v3.6 效果（方案A）
• 渡化门槛：save_required=6（方案B 可选 5）
• 其余：发愿、皈依、投资、持续帮助、团队合作 AI、众生池、生存消耗等与 v3.5 一致

【平衡目标】
• 全皈依+平衡胜率：85–92%
• 失败原因：劫难相关占约 5–25%，渡化不足占其余大部分
• 综合排名分：各角色尽量接近 0（学者/僧侣 v3.5 已接近 0；农夫通过事件卡与整体难度缓解偏弱）

▌5.1 实测结果（本次运行：种子 42，每方案 800 局）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

• 基线（v3.5 默认事件）：胜率 90.9%；失败 73 局均为渡化不足，劫难/两者 0
• 方案A（v3.6 事件微调）：胜率 90.9%；失败原因同基线（劫难 0，渡化 73，两者 0）；排名分 农夫 -8、商人 7、学者 -1、僧侣 2
• 方案B（v3.6 事件 + save_required=5）：胜率 99.9%；失败 1 局（渡化）；排名分略均衡（农夫 -7、商人 6、学者 -2、僧侣 3）
• 方案C/D/E/F：胜率均为 90.9%，失败原因 100% 渡化不足
• 方案G（基线 + 每轮劫难+2）：胜率 88.9%；失败 89 局，仍为 100% 渡化不足

说明：本轮 8 组配置下劫难相关失败占比均为 0%，渡化不足仍是唯一失败来源；推荐仍采用方案A（事件卡 v3.6 + save_required=6）。若希望失败原因更多样化，可后续尝试 calamity_per_round>2 或更高劫难上限的扩展测试。结果已写入 模拟测试/tuning_results_v36.json。


═══════════════════════════════════════════════════════════════════════════════
                    六、如何运行回测与调优
═══════════════════════════════════════════════════════════════════════════════

1. 推荐从项目根目录运行启动脚本：python run_merit_cycle_tuning.py（自动切换至 桌游/模拟测试 并执行调优，避免中文路径问题）
2. 或进入 桌游/模拟测试 后运行：python balance_tuning_v36.py
   • 会跑基线 + 方案A/B/C/D/E/F/G，输出胜率、失败原因、排名分与推荐方案，并写入 tuning_results_v36.json
3. 仅跑回测（自定义事件/配置）：在 Python 中 import backtest_system，使用 BacktestConfig 与 run_full_backtest

详见：桌游/模拟测试/README_回测与v3.6.md


═══════════════════════════════════════════════════════════════════════════════
                    七、文档与代码清单
═══════════════════════════════════════════════════════════════════════════════

【设计提案】
• 功德轮回_v3.6_最终版_回测与平衡报告.txt（本文档）

【模拟测试】
• game_simulator_v3.5_final.py（已含 v3.6 默认事件牌）
• backtest_system.py
• balance_tuning_v36.py
• README_回测与v3.6.md


═══════════════════════════════════════════════════════════════════════════════
                    结语
═══════════════════════════════════════════════════════════════════════════════

v3.6 在 v3.5 基础上完成：
1. 更完善的回测系统（可复现、多情景、失败细分、事件卡参数化）
2. 批判性平衡调优（重点微调事件卡，兼顾渡化门槛等机制）
3. 事件卡最终表与可选方案 B/C
4. 默认模拟器已采用 v3.6 事件牌，可直接用于后续测试与扩展

运行 balance_tuning_v36.py 可获得当前环境下的具体胜率与失败占比，用于验证或进一步微调。


═══════════════════════════════════════════════════════════════════════════════
                    文档结束
                    《功德轮回》v3.6 最终版 - 回测与平衡报告
═══════════════════════════════════════════════════════════════════════════════
